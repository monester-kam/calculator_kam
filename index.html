<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Plano de A√ß√£o</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Montserrat', sans-serif;
            background: linear-gradient(135deg, #4D00AE 0%, #222222 100%);
            color: #222222;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: #FFFFFF;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .header {
            background: linear-gradient(135deg, #4D00AE 0%, #7740F9 100%);
            color: #FFFFFF;
            padding: 40px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.2em;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            font-weight: 300;
            opacity: 0.9;
        }
        
        .content {
            padding: 40px;
        }
        
        .section {
            margin-bottom: 40px;
        }
        
        .section-title {
            background: linear-gradient(135deg, #7740F9 0%, #13AAE6 100%);
            color: #FFFFFF;
            padding: 15px 25px;
            border-radius: 10px;
            font-size: 1.4em;
            font-weight: 700;
            margin-bottom: 20px;
        }
        
        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .input-group {
            background: #F8F9FA;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #7740F9;
        }
        
        .input-group label {
            display: block;
            color: #4D00AE;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.95em;
        }
        
        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #DDDDDD;
            border-radius: 8px;
            font-family: 'Montserrat', sans-serif;
            font-size: 1em;
            transition: border 0.3s ease;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: #7740F9;
        }
        
        .input-group input[type="number"] {
            text-align: right;
        }
        
        .playbook-btn {
            display: inline-block;
            background: linear-gradient(135deg, #3F51B5 0%, #5C6BC0 100%);
            color: #FFFFFF;
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            font-size: 0.9em;
            margin: 5px 5px 5px 0;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(63,81,181,0.3);
        }
        
        .playbook-btn:hover {
            background: linear-gradient(135deg, #303F9F 0%, #3F51B5 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(63,81,181,0.4);
        }
        
        .calculate-btn {
            background: linear-gradient(135deg, #4D00AE 0%, #7740F9 100%);
            color: #FFFFFF;
            border: none;
            padding: 18px 50px;
            font-size: 1.2em;
            font-weight: 700;
            border-radius: 50px;
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(77,0,174,0.3);
            display: block;
            margin: 30px auto;
        }
        
        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(77,0,174,0.4);
        }
        
        .results-section {
            display: none;
            margin-top: 40px;
        }
        
        .results-section.active {
            display: block;
        }
        
        .result-card {
            background: linear-gradient(135deg, #D5BFF1 0%, #FFFFFF 100%);
            padding: 30px;
            border-radius: 15px;
            margin: 20px 0;
            border-left: 5px solid #4D00AE;
        }
        
        .result-title {
            color: #4D00AE;
            font-size: 1.3em;
            font-weight: 700;
            margin-bottom: 15px;
        }
        
        .result-value {
            color: #7740F9;
            font-size: 2em;
            font-weight: 700;
            margin: 10px 0;
        }
        
        .result-description {
            color: #666;
            font-size: 0.95em;
            margin-top: 10px;
        }
        
        .funnel-table {
            width: 100%;
            border-collapse: collapse;
            margin: 30px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .funnel-table thead {
            background: linear-gradient(135deg, #4D00AE 0%, #7740F9 100%);
            color: #FFFFFF;
        }
        
        .funnel-table th {
            padding: 18px;
            text-align: left;
            font-weight: 600;
        }
        
        .funnel-table td {
            padding: 15px 18px;
            border-bottom: 1px solid #DDDDDD;
        }
        
        .funnel-table tbody tr:hover {
            background: #D5BFF1;
            transition: background 0.3s ease;
        }
        
        .funnel-table .step-number {
            background: #7740F9;
            color: #FFFFFF;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }
        
        .funnel-table .metric-name {
            font-weight: 600;
            color: #4D00AE;
        }
        
        .funnel-table .metric-value {
            font-weight: 700;
            color: #7740F9;
            font-size: 1.1em;
        }
        
        .highlight-row {
            background: #13AAE6 !important;
            color: #FFFFFF !important;
        }
        
        .highlight-row td {
            color: #FFFFFF !important;
            font-weight: 700 !important;
        }
        
        .alert-box {
            background: #13AAE6;
            color: #FFFFFF;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            font-weight: 600;
            text-align: center;
        }
        
        .warning-box {
            background: #DDDDDD;
            border-left: 5px solid #7740F9;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .success-box {
            background: #E8F5E9;
            border-left: 5px solid #4CAF50;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            color: #2E7D32;
            font-weight: 600;
        }
        
        .config-box {
            background: #222222;
            color: #FFFFFF;
            padding: 25px;
            border-radius: 15px;
            margin: 30px 0;
        }
        
        .config-box h3 {
            color: #13AAE6;
            margin-bottom: 15px;
        }
        
        .config-item {
            padding: 10px 0;
            border-bottom: 1px solid #444;
        }
        
        .config-item:last-child {
            border-bottom: none;
        }
        
        .config-label {
            color: #D5BFF1;
            font-weight: 600;
        }
        
        .config-value {
            color: #13AAE6;
            font-weight: 700;
            font-size: 1.2em;
        }
        
        .comparison-box {
            background: linear-gradient(135deg, #FFF3E0 0%, #FFE0B2 100%);
            border-left: 5px solid #FF9800;
            padding: 25px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .comparison-box h4 {
            color: #E65100;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        
        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 15px;
        }
        
        .comparison-item {
            background: #FFFFFF;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #FF9800;
        }
        
        .comparison-label {
            color: #E65100;
            font-weight: 600;
            font-size: 0.9em;
            margin-bottom: 8px;
        }
        
        .comparison-value {
            color: #FF6F00;
            font-weight: 700;
            font-size: 1.3em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Calculadora de Plano de A√ß√£o</h1>
            <p>Sistema de c√°lculo para planejamento estrat√©gico de contas novas</p>
        </div>
        
        <div class="content">
            <!-- Dados do Cliente -->
            <div class="section">
                <div class="section-title">üìã Dados do Cliente</div>
                <div class="input-grid">
                    <div class="input-group">
                        <label>Nome do Cliente</label>
                        <input type="text" id="clientName" placeholder="Ex: Banco Nova Era">
                    </div>
                    <div class="input-group">
                        <label>Base de CPF Ativa</label>
                        <input type="number" id="baseSize" placeholder="Ex: 52182">
                    </div>
                    <div class="input-group">
                        <label>Atendimentos Contratados (M√≠nimo Garantido)</label>
                        <input type="number" id="minAttendance" placeholder="Ex: 10000">
                    </div>
                </div>
            </div>
            
            <!-- Dados Comerciais -->
            <div class="section">
                <div class="section-title">üí∞ Dados Comerciais</div>
                <div class="input-grid">
                    <div class="input-group">
                        <label>Valor por Atendimento (R$)</label>
                        <input type="number" step="0.01" id="valuePerAttendance" placeholder="Ex: 1.79">
                    </div>
                    <div class="input-group">
                        <label>Licen√ßa da Plataforma (R$)</label>
                        <input type="number" step="0.01" id="platformLicense" placeholder="Ex: 2985.00">
                    </div>
                    <div class="input-group">
                        <label>ROI Objetivo (multiplicador)</label>
                        <input type="number" step="0.1" id="targetROI" value="10" placeholder="Ex: 10" min="2">
                        <div style="color: #FF9800; font-size: 0.85em; margin-top: 5px; font-style: italic;">
                            M√≠nimo recomendado: 10x
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Dados do Funil -->
            <div class="section">
                <div class="section-title">üìä Dados do Funil (%)</div>
                <div class="input-grid">
                    <div class="input-group">
                        <label>Taxa de Entrega WhatsApp (%)</label>
                        <input type="number" step="0.1" id="deliveryRate" value="95" placeholder="Ex: 95">
                        <div style="color: #13AAE6; font-size: 0.85em; margin-top: 5px; font-style: italic;">
                            Deixe vazio para usar taxa recomendada
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Taxa de Resposta (%)</label>
                        <input type="number" step="0.1" id="responseRate" value="20" placeholder="Ex: 20">
                        <div style="color: #13AAE6; font-size: 0.85em; margin-top: 5px; font-style: italic;">
                            Deixe vazio para usar taxa recomendada
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Taxa de CPC (%)</label>
                        <input type="number" step="0.1" id="cpcRate" value="56" placeholder="Ex: 56">
                        <div style="color: #13AAE6; font-size: 0.85em; margin-top: 5px; font-style: italic;">
                            Deixe vazio para usar taxa recomendada
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Taxa de Convers√£o (%)</label>
                        <input type="number" step="0.1" id="conversionRate" value="23" placeholder="Ex: 23">
                        <div style="color: #13AAE6; font-size: 0.85em; margin-top: 5px; font-style: italic;">
                            Deixe vazio para usar taxa recomendada
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Efetividade de Pagamento (%)</label>
                        <input type="number" step="0.1" id="paymentRate" value="40" placeholder="Ex: 40">
                        <div style="color: #13AAE6; font-size: 0.85em; margin-top: 5px; font-style: italic;">
                            Deixe vazio para usar taxa recomendada
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Ticket M√©dio (R$)</label>
                        <input type="number" step="0.01" id="avgTicket" placeholder="Ex: 285.00 ou deixe vazio">
                        <div style="color: #13AAE6; font-size: 0.85em; margin-top: 5px; font-style: italic;">
                            Deixe vazio para calcular automaticamente
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Dados Temporais -->
            <div class="section">
                <div class="section-title">üìÖ Dados Temporais</div>
                <div class="input-grid">
                    <div class="input-group">
                        <label>Dias √öteis do M√™s</label>
                        <input type="number" id="workDays" value="21" placeholder="Ex: 21" min="1" max="31">
                    </div>
                    <div class="input-group">
                        <label>Prazo de Vencimento (dias)</label>
                        <input type="number" id="paymentDeadline" value="3" placeholder="Ex: 3" min="0">
                    </div>
                </div>
            </div>
            
            <button class="calculate-btn" onclick="calculate()">üöÄ CALCULAR PLANO DE A√á√ÉO</button>
            
            <!-- Resultados -->
            <div class="results-section" id="results">
                <div class="section-title">üìà Resultados do Plano de A√ß√£o</div>
                
                <!-- An√°lise de Cen√°rios -->
                <div id="scenarioAnalysis"></div>
                
                <!-- Investimento e ROI -->
                <div class="result-card">
                    <div class="result-title">üíµ An√°lise Financeira</div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                        <div>
                            <div style="color: #666; font-size: 0.9em;">Investimento Total</div>
                            <div class="result-value" id="totalInvestment">-</div>
                        </div>
                        <div>
                            <div style="color: #666; font-size: 0.9em;">Valor a Recuperar</div>
                            <div class="result-value" id="targetRecovery">-</div>
                        </div>
                        <div>
                            <div style="color: #666; font-size: 0.9em;">ROI Efetivo</div>
                            <div class="result-value" id="roiDisplay">-</div>
                        </div>
                    </div>
                </div>
                
                <!-- Funil Reverso -->
                <table class="funnel-table">
                    <thead>
                        <tr>
                            <th>Etapa</th>
                            <th>M√©trica</th>
                            <th>Valor</th>
                            <th>Taxa/C√°lculo</th>
                        </tr>
                    </thead>
                    <tbody id="funnelTableBody">
                    </tbody>
                </table>
                
                <!-- Configura√ß√µes Operacionais -->
                <div class="config-box">
                    <h3>‚öôÔ∏è Configura√ß√µes Operacionais</h3>
                    <div class="config-item">
                        <span class="config-label">Disparos por dia:</span>
                        <span class="config-value" id="dailyDispatches">-</span>
                    </div>
                    <div class="config-item">
                        <span class="config-label">Espa√ßamento entre disparos:</span>
                        <span class="config-value" id="dispatchSpacing">-</span>
                    </div>
                    <div class="config-item">
                        <span class="config-label">Penetra√ß√£o de base:</span>
                        <span class="config-value" id="basePenetration">-</span>
                    </div>
                    <div class="config-item">
                        <span class="config-label">Dias √∫teis produtivos:</span>
                        <span class="config-value" id="productiveDays">-</span>
                    </div>
                    <div class="config-item">
                        <span class="config-label">Capacidade total da base:</span>
                        <span class="config-value" id="baseCapacity">-</span>
                    </div>
                    <div class="config-item">
                        <span class="config-label">Margem de seguran√ßa:</span>
                        <span class="config-value" id="safetyMargin">-</span>
                    </div>
                </div>
                
                <div id="alertMessages"></div>
                
                <!-- Bot√£o de Download PDF -->
                <div style="text-align: center; margin-top: 30px;">
                    <button class="calculate-btn" onclick="downloadPDF()" style="background: linear-gradient(135deg, #13AAE6 0%, #4D00AE 100%);">
                        üìÑ BAIXAR PLANO DE A√á√ÉO EM PDF
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // üîí VALIDA√á√ÉO DE SEGURAN√áA - S√≥ funciona embedado no Notion
        (function() {
            const referrer = document.referrer.toLowerCase();
            const isNotion = referrer.includes('notion.so') || referrer.includes('notion.site');
            const isLocalTest = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
            
            // Permite acesso apenas do Notion ou teste local
            if (!isNotion && !isLocalTest && referrer !== '') {
                document.body.innerHTML = `
                    <div style="
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        justify-content: center;
                        height: 100vh;
                        background: linear-gradient(135deg, #4D00AE 0%, #222222 100%);
                        color: #FFFFFF;
                        font-family: 'Montserrat', sans-serif;
                        text-align: center;
                        padding: 40px;
                    ">
                        <div style="
                            background: rgba(255,255,255,0.1);
                            padding: 60px 40px;
                            border-radius: 20px;
                            backdrop-filter: blur(10px);
                            max-width: 600px;
                        ">
                            <h1 style="font-size: 3em; margin-bottom: 20px;">üîí</h1>
                            <h2 style="font-size: 2em; margin-bottom: 20px;">Acesso Restrito</h2>
                            <p style="font-size: 1.2em; line-height: 1.6; opacity: 0.9;">
                                Esta calculadora √© de uso exclusivo da equipe Monest<br>
                                e s√≥ pode ser acessada atrav√©s do Notion.
                            </p>
                            <p style="font-size: 1em; margin-top: 30px; opacity: 0.7;">
                                Se voc√™ √© membro da equipe, acesse atrav√©s do workspace Notion.
                            </p>
                        </div>
                    </div>
                `;
                throw new Error('Acesso negado: Origem n√£o autorizada');
            }
        })();
        
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value);
        }
        
        function formatNumber(value) {
            return new Intl.NumberFormat('pt-BR').format(Math.round(value));
        }
        
        function formatPercent(value) {
            return value.toFixed(1) + '%';
        }
        
        function calculate() {
            // Capturar dados
            const baseSize = parseFloat(document.getElementById('baseSize').value);
            const minAttendance = parseFloat(document.getElementById('minAttendance').value);
            const valuePerAttendance = parseFloat(document.getElementById('valuePerAttendance').value);
            const platformLicense = parseFloat(document.getElementById('platformLicense').value);
            const targetROI = parseFloat(document.getElementById('targetROI').value);
            
            // Taxas do funil com valores recomendados padr√£o
            const defaultRates = {
                delivery: 95,
                response: 20,
                cpc: 56,
                conversion: 23,
                payment: 40
            };
            
            // Premissas Monest (benchmarks internos)
            const monestBenchmarks = {
                delivery: 95,
                response: 20,
                cpc: 56,
                conversion: 23,
                payment: 40,
                penetration: 90  // % m√°ximo recomendado de penetra√ß√£o (0.9x)
            };
            
            let deliveryRate = parseFloat(document.getElementById('deliveryRate').value);
            let responseRate = parseFloat(document.getElementById('responseRate').value);
            let cpcRate = parseFloat(document.getElementById('cpcRate').value);
            let conversionRate = parseFloat(document.getElementById('conversionRate').value);
            let paymentRate = parseFloat(document.getElementById('paymentRate').value);
            let avgTicket = parseFloat(document.getElementById('avgTicket').value);
            
            // Controle de quais campos foram auto-calculados
            let autoCalculated = {
                delivery: false,
                response: false,
                cpc: false,
                conversion: false,
                payment: false,
                ticket: false
            };
            
            // Aplicar valores recomendados se campos estiverem vazios
            if (isNaN(deliveryRate) || deliveryRate <= 0) {
                deliveryRate = defaultRates.delivery;
                document.getElementById('deliveryRate').value = deliveryRate;
                autoCalculated.delivery = true;
            }
            deliveryRate = deliveryRate / 100;
            
            if (isNaN(responseRate) || responseRate <= 0) {
                responseRate = defaultRates.response;
                document.getElementById('responseRate').value = responseRate;
                autoCalculated.response = true;
            }
            responseRate = responseRate / 100;
            
            if (isNaN(cpcRate) || cpcRate <= 0) {
                cpcRate = defaultRates.cpc;
                document.getElementById('cpcRate').value = cpcRate;
                autoCalculated.cpc = true;
            }
            cpcRate = cpcRate / 100;
            
            if (isNaN(conversionRate) || conversionRate <= 0) {
                conversionRate = defaultRates.conversion;
                document.getElementById('conversionRate').value = conversionRate;
                autoCalculated.conversion = true;
            }
            conversionRate = conversionRate / 100;
            
            if (isNaN(paymentRate) || paymentRate <= 0) {
                paymentRate = defaultRates.payment;
                document.getElementById('paymentRate').value = paymentRate;
                autoCalculated.payment = true;
            }
            paymentRate = paymentRate / 100;
            
            const workDays = parseFloat(document.getElementById('workDays').value);
            const paymentDeadline = parseFloat(document.getElementById('paymentDeadline').value);
            
            // Valida√ß√µes b√°sicas
            if (isNaN(baseSize) || isNaN(minAttendance) || isNaN(valuePerAttendance) || 
                isNaN(platformLicense)) {
                alert('Por favor, preencha todos os campos obrigat√≥rios!');
                return;
            }
            
            // Valida√ß√£o de ROI
            if (targetROI < 2) {
                alert('‚ö†Ô∏è ROI muito baixo!\n\nO ROI m√≠nimo aceit√°vel √© 2x.\n\nROI inferior a 2x indica opera√ß√£o insustent√°vel e alto risco de churn imediato.');
                return;
            }
            
            // C√°lculos financeiros
            const minGuaranteed = minAttendance * valuePerAttendance;
            const totalInvestment = minGuaranteed + platformLicense;
            const targetRecoveryROI = totalInvestment + (totalInvestment * targetROI);
            
            // Se ticket m√©dio n√£o foi preenchido, calcular o necess√°rio
            let ticketAutoCalculated = false;
            if (isNaN(avgTicket) || avgTicket <= 0) {
                // Calcular acordos pagos esperados baseado no m√≠nimo garantido
                const deliveredDispatchesMin = Math.ceil(minAttendance / responseRate);
                const totalDispatchesMin = Math.ceil(deliveredDispatchesMin / deliveryRate);
                const attendancesMin = minAttendance;
                const cpcConfirmedMin = Math.ceil(attendancesMin * cpcRate);
                const generatedAgreementsMin = Math.ceil(cpcConfirmedMin * conversionRate);
                const paidAgreementsMin = Math.ceil(generatedAgreementsMin * paymentRate);
                
                // Ticket necess√°rio para atingir o ROI com o m√≠nimo garantido
                avgTicket = targetRecoveryROI / paidAgreementsMin;
                
                // Atualizar campo
                document.getElementById('avgTicket').value = avgTicket.toFixed(2);
                ticketAutoCalculated = true;
                autoCalculated.ticket = true;
            }
            
            // CEN√ÅRIO 1: Baseado no ROI
            const paidAgreementsROI = Math.ceil(targetRecoveryROI / avgTicket);
            const generatedAgreementsROI = Math.ceil(paidAgreementsROI / paymentRate);
            const cpcConfirmedROI = Math.ceil(generatedAgreementsROI / conversionRate);
            const attendancesROI = Math.ceil(cpcConfirmedROI / cpcRate);
            const deliveredDispatchesROI = Math.ceil(attendancesROI / responseRate);
            const totalDispatchesROI = Math.ceil(deliveredDispatchesROI / deliveryRate);
            
            // CEN√ÅRIO 2: Baseado no M√≠nimo Garantido
            const deliveredDispatchesMin = Math.ceil(minAttendance / responseRate);
            const totalDispatchesMin = Math.ceil(deliveredDispatchesMin / deliveryRate);
            const attendancesMin = minAttendance;
            const cpcConfirmedMin = Math.ceil(attendancesMin * cpcRate);
            const generatedAgreementsMin = Math.ceil(cpcConfirmedMin * conversionRate);
            const paidAgreementsMin = Math.ceil(generatedAgreementsMin * paymentRate);
            const targetRecoveryMin = paidAgreementsMin * avgTicket;
            const effectiveROIMin = (targetRecoveryMin - totalInvestment) / totalInvestment;
            
            // DECIS√ÉO: Qual cen√°rio usar?
            let useMinimumScenario = false;
            let scenarioReason = '';
            let suggestTicketAdjustment = false;
            let recommendedTicket = 0;
            
            if (attendancesROI < minAttendance) {
                useMinimumScenario = true;
                scenarioReason = `O c√°lculo baseado no ROI ${targetROI}x resultaria em apenas ${formatNumber(attendancesROI)} atendimentos, abaixo do m√≠nimo garantido de ${formatNumber(minAttendance)}.`;
                
                // Calcular ticket m√©dio ideal para atingir ROI E m√≠nimo garantido
                // Usando o m√≠nimo garantido como base de atendimentos
                const idealPaidAgreements = Math.ceil(targetRecoveryROI / (attendancesMin * cpcRate * conversionRate * paymentRate));
                recommendedTicket = targetRecoveryROI / (attendancesMin * cpcRate * conversionRate * paymentRate);
                
                if (recommendedTicket > avgTicket * 1.1) { // Se precisar aumentar mais de 10%
                    suggestTicketAdjustment = true;
                }
            }
            
            // Valores finais (baseado no cen√°rio escolhido)
            const totalDispatches = useMinimumScenario ? totalDispatchesMin : totalDispatchesROI;
            const deliveredDispatches = useMinimumScenario ? deliveredDispatchesMin : deliveredDispatchesROI;
            const attendances = useMinimumScenario ? attendancesMin : attendancesROI;
            const cpcConfirmed = useMinimumScenario ? cpcConfirmedMin : cpcConfirmedROI;
            const generatedAgreements = useMinimumScenario ? generatedAgreementsMin : generatedAgreementsROI;
            const paidAgreements = useMinimumScenario ? paidAgreementsMin : paidAgreementsROI;
            const targetRecovery = useMinimumScenario ? targetRecoveryMin : targetRecoveryROI;
            const effectiveROI = useMinimumScenario ? effectiveROIMin : targetROI;
            
            // C√°lculos operacionais
            const dailyDispatches = Math.ceil(totalDispatches / workDays);
            const basePenetration = totalDispatches / baseSize;
            const dispatchSpacing = Math.round(workDays / basePenetration);
            const productiveDays = workDays - paymentDeadline;
            const baseCapacity = Math.floor(baseSize * basePenetration);
            const safetyMargin = ((baseCapacity - totalDispatches) / totalDispatches) * 100;
            
            // Exibir an√°lise de cen√°rios
            let scenarioHTML = '';
            
            // Mostrar taxas auto-calculadas
            let autoRatesMessage = '';
            const autoRatesList = [];
            if (autoCalculated.delivery) autoRatesList.push('Taxa de Entrega: ' + (deliveryRate * 100).toFixed(0) + '%');
            if (autoCalculated.response) autoRatesList.push('Taxa de Resposta: ' + (responseRate * 100).toFixed(0) + '%');
            if (autoCalculated.cpc) autoRatesList.push('Taxa de CPC: ' + (cpcRate * 100).toFixed(0) + '%');
            if (autoCalculated.conversion) autoRatesList.push('Taxa de Convers√£o: ' + (conversionRate * 100).toFixed(0) + '%');
            if (autoCalculated.payment) autoRatesList.push('Efetividade de Pagamento: ' + (paymentRate * 100).toFixed(0) + '%');
            
            if (autoRatesList.length > 0) {
                autoRatesMessage = `
                    <div style="background: #E3F2FD; padding: 20px; border-radius: 10px; margin-bottom: 15px; border-left: 5px solid #2196F3;">
                        <h4 style="color: #1565C0; margin-bottom: 10px;">üìä Taxas Recomendadas Aplicadas</h4>
                        <p style="color: #555; margin-bottom: 10px;">
                            Os seguintes campos foram preenchidos automaticamente com taxas recomendadas baseadas em hist√≥rico de opera√ß√µes:
                        </p>
                        <ul style="color: #555; margin-left: 20px;">
                            ${autoRatesList.map(rate => '<li>' + rate + '</li>').join('')}
                        </ul>
                        <p style="color: #555; margin-top: 10px; font-size: 0.95em;">
                            <strong>üí° Dica:</strong> Voc√™ pode ajustar estes valores a qualquer momento com base nos dados reais da sua opera√ß√£o.
                        </p>
                    </div>
                `;
            }
            
            if (useMinimumScenario) {
                let ticketAdjustmentHTML = '';
                if (suggestTicketAdjustment) {
                    const ticketIncrease = ((recommendedTicket - avgTicket) / avgTicket) * 100;
                    ticketAdjustmentHTML = `
                        <div style="background: #FFF3E0; padding: 20px; border-radius: 10px; margin-top: 20px; border-left: 5px solid #FF9800;">
                            <h4 style="color: #E65100; margin-bottom: 15px;">üí° Recomenda√ß√£o: Ajuste de Ticket M√©dio</h4>
                            <p style="margin-bottom: 15px; color: #555;">
                                Para atingir simultaneamente o <strong>ROI de ${targetROI}x</strong> e o <strong>m√≠nimo garantido de ${formatNumber(minAttendance)} atendimentos</strong>, 
                                seria necess√°rio um ticket m√©dio maior.
                            </p>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-top: 15px;">
                                <div style="background: #FFFFFF; padding: 15px; border-radius: 8px; border: 2px solid #FF9800;">
                                    <div style="color: #E65100; font-weight: 600; font-size: 0.9em; margin-bottom: 8px;">Ticket Atual</div>
                                    <div style="color: #FF6F00; font-weight: 700; font-size: 1.3em;">${formatCurrency(avgTicket)}</div>
                                </div>
                                <div style="background: #FFFFFF; padding: 15px; border-radius: 8px; border: 2px solid #4CAF50;">
                                    <div style="color: #2E7D32; font-weight: 600; font-size: 0.9em; margin-bottom: 8px;">Ticket Recomendado</div>
                                    <div style="color: #1B5E20; font-weight: 700; font-size: 1.3em;">${formatCurrency(recommendedTicket)}</div>
                                </div>
                                <div style="background: #FFFFFF; padding: 15px; border-radius: 8px; border: 2px solid #13AAE6;">
                                    <div style="color: #0277BD; font-weight: 600; font-size: 0.9em; margin-bottom: 8px;">Aumento Necess√°rio</div>
                                    <div style="color: #01579B; font-weight: 700; font-size: 1.3em;">+${ticketIncrease.toFixed(1)}%</div>
                                </div>
                            </div>
                            <p style="margin-top: 15px; color: #555; font-size: 0.95em;">
                                <strong>A√ß√µes poss√≠veis:</strong><br>
                                ‚Ä¢ Trabalhar com ofertas de valores maiores (aumentar ticket m√©dio)<br>
                                ‚Ä¢ Focar em devedores com d√©bitos de maior valor<br>
                                ‚Ä¢ Ajustar estrat√©gia de negocia√ß√£o para aumentar valor m√©dio dos acordos<br>
                                ‚Ä¢ Revisar o ROI objetivo ou aumentar o m√≠nimo garantido
                            </p>
                        </div>
                    `;
                }
                
                let autoTicketMessage = '';
                if (ticketAutoCalculated) {
                    autoTicketMessage = `
                        <div style="background: #E8F5E9; padding: 15px; border-radius: 10px; margin-top: 15px; border-left: 5px solid #4CAF50;">
                            <p style="color: #2E7D32; font-weight: 600;">
                                ‚úÖ <strong>Ticket M√©dio Calculado Automaticamente:</strong> ${formatCurrency(avgTicket)}
                            </p>
                            <p style="color: #555; margin-top: 8px; font-size: 0.95em;">
                                Este √© o valor m√≠nimo necess√°rio por acordo para atingir o ROI de ${targetROI}x com o m√≠nimo garantido de ${formatNumber(minAttendance)} atendimentos.
                            </p>
                        </div>
                    `;
                }
                
                scenarioHTML = `
                    ${autoRatesMessage}
                    ${autoTicketMessage}
                    <div class="comparison-box">
                        <h4>‚ö†Ô∏è Ajuste Autom√°tico: Prioriza√ß√£o do M√≠nimo Garantido</h4>
                        <p style="margin-bottom: 15px;"><strong>Motivo:</strong> ${scenarioReason}</p>
                        <p style="margin-bottom: 15px;">O sistema recalculou automaticamente priorizando o <strong>m√≠nimo garantido de ${formatNumber(minAttendance)} atendimentos</strong>. Isso resultar√° em um ROI efetivo maior que o objetivo inicial.</p>
                        
                        <div class="comparison-grid">
                            <div class="comparison-item">
                                <div class="comparison-label">ROI Objetivo Original</div>
                                <div class="comparison-value">${targetROI}x</div>
                            </div>
                            <div class="comparison-item">
                                <div class="comparison-label">ROI Efetivo Ajustado</div>
                                <div class="comparison-value">${effectiveROI.toFixed(1)}x</div>
                            </div>
                            <div class="comparison-item">
                                <div class="comparison-label">Atendimentos (ROI)</div>
                                <div class="comparison-value">${formatNumber(attendancesROI)}</div>
                            </div>
                            <div class="comparison-item">
                                <div class="comparison-label">Atendimentos (Ajustado)</div>
                                <div class="comparison-value" style="color: #4CAF50;">${formatNumber(minAttendance)} ‚úì</div>
                            </div>
                        </div>
                        ${ticketAdjustmentHTML}
                    </div>
                `;
            } else {
                let autoTicketMessage = '';
                if (ticketAutoCalculated) {
                    autoTicketMessage = `
                        <div style="background: #E8F5E9; padding: 20px; border-radius: 10px; margin-bottom: 15px; border-left: 5px solid #4CAF50;">
                            <h4 style="color: #2E7D32; margin-bottom: 10px;">‚úÖ Ticket M√©dio Calculado Automaticamente</h4>
                            <p style="color: #555; margin-bottom: 10px;">
                                <strong>Ticket M√©dio Calculado:</strong> ${formatCurrency(avgTicket)}
                            </p>
                            <p style="color: #555; font-size: 0.95em;">
                                Este √© o valor ideal por acordo para atingir simultaneamente:<br>
                                ‚Ä¢ ROI de ${targetROI}x (${formatCurrency(targetRecovery)} recuperado)<br>
                                ‚Ä¢ M√≠nimo garantido de ${formatNumber(minAttendance)} atendimentos
                            </p>
                        </div>
                    `;
                }
                
                scenarioHTML = `
                    ${autoRatesMessage}
                    ${autoTicketMessage}
                    <div class="success-box">
                        ‚úÖ <strong>Cen√°rio Ideal Alcan√ßado!</strong> O c√°lculo baseado no ROI ${targetROI}x resulta em ${formatNumber(attendances)} atendimentos, 
                        superando o m√≠nimo garantido de ${formatNumber(minAttendance)} em ${formatNumber(attendances - minAttendance)} atendimentos 
                        (+${((attendances - minAttendance) / minAttendance * 100).toFixed(1)}%).
                    </div>
                `;
            }
            document.getElementById('scenarioAnalysis').innerHTML = scenarioHTML;
            
            // Exibir resultados financeiros
            document.getElementById('totalInvestment').textContent = formatCurrency(totalInvestment);
            document.getElementById('targetRecovery').textContent = formatCurrency(targetRecovery);
            document.getElementById('roiDisplay').textContent = effectiveROI.toFixed(1) + 'x';
            
            // Construir tabela do funil
            const funnelData = [
                { step: '1', name: 'Disparos Agendados', value: totalDispatches, calc: 'Total do m√™s' },
                { step: '‚Üì', name: 'Taxa de Entrega', value: formatPercent(deliveryRate * 100), calc: '-' },
                { step: '2', name: 'Disparos Entregues', value: deliveredDispatches, calc: totalDispatches + ' √ó ' + formatPercent(deliveryRate * 100) },
                { step: '‚Üì', name: 'Taxa de Resposta', value: formatPercent(responseRate * 100), calc: '-' },
                { step: '3', name: 'Atendimentos', value: attendances, calc: deliveredDispatches + ' √ó ' + formatPercent(responseRate * 100) },
                { step: '‚Üì', name: 'Taxa de CPC', value: formatPercent(cpcRate * 100), calc: '-' },
                { step: '4', name: 'Identidade Confirmada', value: cpcConfirmed, calc: attendances + ' √ó ' + formatPercent(cpcRate * 100) },
                { step: '‚Üì', name: 'Taxa de Convers√£o', value: formatPercent(conversionRate * 100), calc: '-' },
                { step: '5', name: 'Acordos Gerados', value: generatedAgreements, calc: cpcConfirmed + ' √ó ' + formatPercent(conversionRate * 100) },
                { step: '‚Üì', name: 'Efetividade de Pagamento', value: formatPercent(paymentRate * 100), calc: '-' },
                { step: '6', name: 'Acordos Pagos', value: paidAgreements, calc: generatedAgreements + ' √ó ' + formatPercent(paymentRate * 100), highlight: true },
                { step: '=', name: 'Valor Recuperado', value: formatCurrency(targetRecovery), calc: paidAgreements + ' √ó ' + formatCurrency(avgTicket), highlight: true }
            ];
            
            let tableHTML = '';
            funnelData.forEach(row => {
                const rowClass = row.highlight ? 'highlight-row' : '';
                const stepDisplay = row.step.match(/\d+/) ? `<span class="step-number">${row.step}</span>` : row.step;
                const valueDisplay = typeof row.value === 'number' ? formatNumber(row.value) : row.value;
                
                tableHTML += `
                    <tr class="${rowClass}">
                        <td>${stepDisplay}</td>
                        <td class="metric-name">${row.name}</td>
                        <td class="metric-value">${valueDisplay}</td>
                        <td>${row.calc}</td>
                    </tr>
                `;
            });
            
            document.getElementById('funnelTableBody').innerHTML = tableHTML;
            
            // Configura√ß√µes operacionais
            document.getElementById('dailyDispatches').textContent = formatNumber(dailyDispatches);
            document.getElementById('dispatchSpacing').textContent = dispatchSpacing + ' dias';
            document.getElementById('basePenetration').textContent = basePenetration.toFixed(2) + 'x';
            document.getElementById('productiveDays').textContent = productiveDays + ' D.U.';
            document.getElementById('baseCapacity').textContent = formatNumber(baseCapacity) + ' disparos';
            document.getElementById('safetyMargin').textContent = safetyMargin.toFixed(1) + '%';
            
            // Alertas
            let alerts = '';
            
            // Alerta de indicadores abaixo da premissa Monest
            const belowBenchmark = [];
            const actualRates = {
                delivery: deliveryRate * 100,
                response: responseRate * 100,
                cpc: cpcRate * 100,
                conversion: conversionRate * 100,
                payment: paymentRate * 100
            };
            
            if (actualRates.delivery < monestBenchmarks.delivery) {
                belowBenchmark.push({
                    name: 'Taxa de Entrega',
                    atual: actualRates.delivery.toFixed(1) + '%',
                    premissa: monestBenchmarks.delivery + '%',
                    gap: (monestBenchmarks.delivery - actualRates.delivery).toFixed(1) + 'pp'
                });
            }
            if (actualRates.response < monestBenchmarks.response) {
                belowBenchmark.push({
                    name: 'Taxa de Resposta',
                    atual: actualRates.response.toFixed(1) + '%',
                    premissa: monestBenchmarks.response + '%',
                    gap: (monestBenchmarks.response - actualRates.response).toFixed(1) + 'pp'
                });
            }
            if (actualRates.cpc < monestBenchmarks.cpc) {
                belowBenchmark.push({
                    name: 'Taxa de CPC',
                    atual: actualRates.cpc.toFixed(1) + '%',
                    premissa: monestBenchmarks.cpc + '%',
                    gap: (monestBenchmarks.cpc - actualRates.cpc).toFixed(1) + 'pp'
                });
            }
            if (actualRates.conversion < monestBenchmarks.conversion) {
                belowBenchmark.push({
                    name: 'Taxa de Convers√£o',
                    atual: actualRates.conversion.toFixed(1) + '%',
                    premissa: monestBenchmarks.conversion + '%',
                    gap: (monestBenchmarks.conversion - actualRates.conversion).toFixed(1) + 'pp'
                });
            }
            if (actualRates.payment < monestBenchmarks.payment) {
                belowBenchmark.push({
                    name: 'Efetividade de Pagamento',
                    atual: actualRates.payment.toFixed(1) + '%',
                    premissa: monestBenchmarks.payment + '%',
                    gap: (monestBenchmarks.payment - actualRates.payment).toFixed(1) + 'pp'
                });
            }
            
            if (belowBenchmark.length > 0) {
                alerts += `<div class="warning-box" style="background: #E8EAF6; border-left-color: #3F51B5;">
                    <strong style="color: #283593;">üìä OPORTUNIDADE DE MELHORIA NOS INDICADORES</strong><br><br>
                    <span style="color: #555;">
                        Os seguintes indicadores est√£o <strong>abaixo da premissa Monest</strong>:<br><br>
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.95em;">
                            <thead>
                                <tr style="background: #C5CAE9;">
                                    <th style="padding: 8px; text-align: left; border: 1px solid #9FA8DA;">Indicador</th>
                                    <th style="padding: 8px; text-align: center; border: 1px solid #9FA8DA;">Atual</th>
                                    <th style="padding: 8px; text-align: center; border: 1px solid #9FA8DA;">Premissa Monest</th>
                                    <th style="padding: 8px; text-align: center; border: 1px solid #9FA8DA;">Gap</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${belowBenchmark.map(item => `
                                    <tr>
                                        <td style="padding: 8px; border: 1px solid #9FA8DA;"><strong>${item.name}</strong></td>
                                        <td style="padding: 8px; text-align: center; border: 1px solid #9FA8DA; color: #F57C00;"><strong>${item.atual}</strong></td>
                                        <td style="padding: 8px; text-align: center; border: 1px solid #9FA8DA; color: #4CAF50;"><strong>${item.premissa}</strong></td>
                                        <td style="padding: 8px; text-align: center; border: 1px solid #9FA8DA; color: #D32F2F;"><strong>${item.gap}</strong></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <br>
                        <strong style="color: #283593;">üí° Impacto da melhoria:</strong><br>
                        Elevar estes indicadores ao n√≠vel da premissa Monest resultar√° em:<br>
                        ‚Ä¢ Redu√ß√£o significativa do custo por acordo<br>
                        ‚Ä¢ Melhoria do ROI da opera√ß√£o<br>
                        ‚Ä¢ Maior efici√™ncia operacional<br>
                        ‚Ä¢ Redu√ß√£o de risco de churn<br><br>
                        
                        <strong style="color: #283593;">üìö Para melhorias neste processo, acesse:</strong><br><br>
                        <div style="margin-top: 10px;">
                            ${belowBenchmark.map(item => {
                                const links = {
                                    'Taxa de Entrega': 'https://www.notion.so/monest/Playbook-KAM-Monest-29567bc6740a809c8268f0f9e500d85d?source=copy_link#2e267bc6740a80cc941ed3a1f8c2ebab',
                                    'Taxa de Resposta': 'https://www.notion.so/monest/Playbook-KAM-Monest-29567bc6740a809c8268f0f9e500d85d?source=copy_link#2e267bc6740a803e964dcbf3243b8948',
                                    'Taxa de CPC': 'https://www.notion.so/monest/Playbook-KAM-Monest-29567bc6740a809c8268f0f9e500d85d?source=copy_link#2e267bc6740a80979f36ccdbebc961a9',
                                    'Taxa de Convers√£o': 'https://www.notion.so/monest/Playbook-KAM-Monest-29567bc6740a809c8268f0f9e500d85d?source=copy_link#2e267bc6740a807cb0f5d9ac569fd207',
                                    'Efetividade de Pagamento': 'https://www.notion.so/monest/Playbook-KAM-Monest-29567bc6740a809c8268f0f9e500d85d?source=copy_link#2e267bc6740a80c8b270e1130812f023'
                                };
                                const link = links[item.name];
                                return link ? `<a href="${link}" target="_blank" class="playbook-btn">üìñ ${item.name} - Acessar Playbook</a>` : '';
                            }).join('')}
                        </div>
                    </span>
                </div>`;
            }
            
            // Alerta de ROI baixo
            if (targetROI >= 2 && targetROI < 10) {
                const roiHealthLevel = targetROI < 5 ? 'CR√çTICA' : targetROI < 7 ? 'PREOCUPANTE' : 'ATEN√á√ÉO';
                const roiHealthColor = targetROI < 5 ? '#D32F2F' : targetROI < 7 ? '#F57C00' : '#FF9800';
                const roiHealthBg = targetROI < 5 ? '#FFEBEE' : targetROI < 7 ? '#FFF3E0' : '#FFF8E1';
                
                alerts += `<div class="warning-box" style="background: ${roiHealthBg}; border-left-color: ${roiHealthColor};">
                    <strong style="color: ${roiHealthColor};">‚ö†Ô∏è SA√öDE DA OPERA√á√ÉO: ${roiHealthLevel}</strong><br><br>
                    <span style="color: #555;">
                        <strong>ROI configurado:</strong> ${targetROI}x (abaixo do recomendado de 10x)<br><br>
                        
                        <strong>An√°lise de impacto:</strong><br>
                        ${targetROI < 5 ? 
                            '‚Ä¢ <strong style="color: #D32F2F;">CR√çTICO:</strong> Custo da MIA extremamente elevado<br>' +
                            '‚Ä¢ <strong style="color: #D32F2F;">Alto risco de churn imediato</strong><br>' +
                            '‚Ä¢ Opera√ß√£o insustent√°vel a m√©dio/longo prazo<br>' +
                            '‚Ä¢ Margem de lucro comprometida<br><br>' +
                            '<strong style="color: #D32F2F;">A√ß√£o urgente necess√°ria!</strong>' 
                        : targetROI < 7 ?
                            '‚Ä¢ <strong style="color: #F57C00;">PREOCUPANTE:</strong> Custo da MIA muito elevado<br>' +
                            '‚Ä¢ Risco significativo de churn a m√©dio prazo<br>' +
                            '‚Ä¢ Sustentabilidade da opera√ß√£o comprometida<br>' +
                            '‚Ä¢ Necess√°rio monitoramento constante<br><br>' +
                            '<strong style="color: #F57C00;">Requer aten√ß√£o priorit√°ria</strong>'
                        :
                            '‚Ä¢ <strong style="color: #FF9800;">ATEN√á√ÉO:</strong> Custo da MIA elevado<br>' +
                            '‚Ä¢ Poss√≠vel risco de churn a longo prazo<br>' +
                            '‚Ä¢ Margem de lucro reduzida<br>' +
                            '‚Ä¢ Recomend√°vel otimiza√ß√£o da opera√ß√£o<br><br>' +
                            '<strong style="color: #FF9800;">Monitoramento recomendado</strong>'
                        }<br><br>
                        
                        <strong>Recomenda√ß√µes:</strong><br>
                        ‚Ä¢ <strong>Otimizar taxas de convers√£o</strong> do funil para reduzir custo por acordo<br>
                        ‚Ä¢ <strong>Aumentar ticket m√©dio</strong> atrav√©s de melhores ofertas de negocia√ß√£o<br>
                        ‚Ä¢ <strong>Melhorar qualidade da base</strong> para aumentar taxa de resposta<br>
                        ‚Ä¢ <strong>Revisar estrat√©gia de abordagem</strong> para maximizar convers√£o<br>
                        ‚Ä¢ <strong>Considerar ajuste de pricing</strong> com o cliente<br>
                        ‚Ä¢ <strong>Avaliar viabilidade</strong> de continuar opera√ß√£o com este ROI
                    </span>
                </div>`;
            }
            
            if (basePenetration > 2) {
                alerts += `<div class="warning-box">
                    <strong>‚ö†Ô∏è Aten√ß√£o:</strong> A penetra√ß√£o de base √© muito alta (${basePenetration.toFixed(2)}x). 
                    Cada CPF ser√° acionado mais de 2 vezes no m√™s. Considere aumentar a base ou revisar as metas.
                </div>`;
            }
            
            if (safetyMargin < 10) {
                alerts += `<div class="warning-box">
                    <strong>‚ö†Ô∏è Aten√ß√£o:</strong> Margem de seguran√ßa baixa (${safetyMargin.toFixed(1)}%). 
                    H√° pouca folga para varia√ß√µes operacionais.
                </div>`;
            }
            
            // Alerta cr√≠tico de qualidade
            if (basePenetration > 4 || dispatchSpacing < 7) {
                alerts += `<div class="warning-box" style="background: #FFEBEE; border-left-color: #D32F2F;">
                    <strong style="color: #C62828;">üö® ALERTA CR√çTICO: Risco de Queda de Qualidade</strong><br><br>
                    <span style="color: #555;">
                        ${basePenetration > 4 ? `<strong>Penetra√ß√£o de base muito alta:</strong> ${basePenetration.toFixed(2)}x (limite recomendado: 4x)<br>` : ''}
                        ${dispatchSpacing < 7 ? `<strong>Espa√ßamento muito curto:</strong> ${dispatchSpacing} dias (m√≠nimo recomendado: 7 dias)<br>` : ''}
                    </span><br>
                    <span style="color: #555;">
                        <strong>Risco identificado:</strong> Alta taxa de den√∫ncia por spam devido ao excesso de acionamentos.<br><br>
                        <strong>Solu√ß√£o recomendada:</strong><br>
                        ‚Ä¢ <strong>Avaliar estrat√©gia de oxigena√ß√£o da base</strong> com o cliente<br>
                        ‚Ä¢ Discutir possibilidades de expans√£o e renova√ß√£o da carteira ativa<br>
                        ‚Ä¢ Analisar inclus√£o de novos CPF para diluir frequ√™ncia de contato<br>
                        ‚Ä¢ Considerar ajuste nas metas de atendimento ou ROI<br>
                        ‚Ä¢ Revisar pol√≠ticas de rec√™ncia e frequ√™ncia de acionamento
                    </span>
                </div>`;
            }
            
            document.getElementById('alertMessages').innerHTML = alerts;
            
            // Mostrar resultados
            document.getElementById('results').classList.add('active');
            document.getElementById('results').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            
            // Capturar dados da √∫ltima calcula√ß√£o
            const clientName = document.getElementById('clientName').value || 'Cliente';
            const baseSize = parseFloat(document.getElementById('baseSize').value);
            const minAttendance = parseFloat(document.getElementById('minAttendance').value);
            const valuePerAttendance = parseFloat(document.getElementById('valuePerAttendance').value);
            const platformLicense = parseFloat(document.getElementById('platformLicense').value);
            const targetROI = parseFloat(document.getElementById('targetROI').value);
            
            const deliveryRate = parseFloat(document.getElementById('deliveryRate').value) / 100;
            const responseRate = parseFloat(document.getElementById('responseRate').value) / 100;
            const cpcRate = parseFloat(document.getElementById('cpcRate').value) / 100;
            const conversionRate = parseFloat(document.getElementById('conversionRate').value) / 100;
            const paymentRate = parseFloat(document.getElementById('paymentRate').value) / 100;
            const avgTicket = parseFloat(document.getElementById('avgTicket').value);
            
            const workDays = parseFloat(document.getElementById('workDays').value);
            const paymentDeadline = parseFloat(document.getElementById('paymentDeadline').value);
            
            // Recalcular valores
            const minGuaranteed = minAttendance * valuePerAttendance;
            const totalInvestment = minGuaranteed + platformLicense;
            const targetRecoveryROI = totalInvestment + (totalInvestment * targetROI);
            const paidAgreementsROI = Math.ceil(targetRecoveryROI / avgTicket);
            const generatedAgreementsROI = Math.ceil(paidAgreementsROI / paymentRate);
            const cpcConfirmedROI = Math.ceil(generatedAgreementsROI / conversionRate);
            const attendancesROI = Math.ceil(cpcConfirmedROI / cpcRate);
            const deliveredDispatchesROI = Math.ceil(attendancesROI / responseRate);
            const totalDispatchesROI = Math.ceil(deliveredDispatchesROI / deliveryRate);
            
            const deliveredDispatchesMin = Math.ceil(minAttendance / responseRate);
            const totalDispatchesMin = Math.ceil(deliveredDispatchesMin / deliveryRate);
            const attendancesMin = minAttendance;
            const cpcConfirmedMin = Math.ceil(attendancesMin * cpcRate);
            const generatedAgreementsMin = Math.ceil(cpcConfirmedMin * conversionRate);
            const paidAgreementsMin = Math.ceil(generatedAgreementsMin * paymentRate);
            const targetRecoveryMin = paidAgreementsMin * avgTicket;
            const effectiveROIMin = (targetRecoveryMin - totalInvestment) / totalInvestment;
            
            let useMinimumScenario = attendancesROI < minAttendance;
            
            const totalDispatches = useMinimumScenario ? totalDispatchesMin : totalDispatchesROI;
            const deliveredDispatches = useMinimumScenario ? deliveredDispatchesMin : deliveredDispatchesROI;
            const attendances = useMinimumScenario ? attendancesMin : attendancesROI;
            const cpcConfirmed = useMinimumScenario ? cpcConfirmedMin : cpcConfirmedROI;
            const generatedAgreements = useMinimumScenario ? generatedAgreementsMin : generatedAgreementsROI;
            const paidAgreements = useMinimumScenario ? paidAgreementsMin : paidAgreementsROI;
            const targetRecovery = useMinimumScenario ? targetRecoveryMin : targetRecoveryROI;
            const effectiveROI = useMinimumScenario ? effectiveROIMin : targetROI;
            
            const dailyDispatches = Math.ceil(totalDispatches / workDays);
            const basePenetration = totalDispatches / baseSize;
            const dispatchSpacing = Math.round(workDays / basePenetration);
            const productiveDays = workDays - paymentDeadline;
            const baseCapacity = Math.floor(baseSize * basePenetration);
            const safetyMargin = ((baseCapacity - totalDispatches) / totalDispatches) * 100;
            
            // Configura√ß√µes de cor
            const primaryColor = [77, 0, 174]; // #4D00AE
            const secondaryColor = [119, 64, 249]; // #7740F9
            const accentColor = [19, 170, 230]; // #13AAE6
            
            let yPos = 20;
            
            // Cabe√ßalho
            doc.setFillColor(...primaryColor);
            doc.rect(0, 0, 210, 45, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.setFont(undefined, 'bold');
            doc.text('PLANO DE A√á√ÉO', 105, 20, { align: 'center' });
            doc.setFontSize(14);
            doc.setFont(undefined, 'normal');
            doc.text(clientName, 105, 30, { align: 'center' });
            doc.setFontSize(10);
            doc.text('Gerado em: ' + new Date().toLocaleDateString('pt-BR'), 105, 38, { align: 'center' });
            
            yPos = 55;
            doc.setTextColor(0, 0, 0);
            
            // Resumo Financeiro
            doc.setFillColor(...secondaryColor);
            doc.rect(10, yPos, 190, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('RESUMO FINANCEIRO', 15, yPos + 6);
            yPos += 12;
            
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text('Investimento Total:', 15, yPos);
            doc.setFont(undefined, 'bold');
            doc.text(formatCurrency(totalInvestment), 195, yPos, { align: 'right' });
            yPos += 6;
            
            doc.setFont(undefined, 'normal');
            doc.text('Valor a Recuperar:', 15, yPos);
            doc.setFont(undefined, 'bold');
            doc.text(formatCurrency(targetRecovery), 195, yPos, { align: 'right' });
            yPos += 6;
            
            doc.setFont(undefined, 'normal');
            doc.text('ROI Efetivo:', 15, yPos);
            doc.setFont(undefined, 'bold');
            doc.text(effectiveROI.toFixed(1) + 'x', 195, yPos, { align: 'right' });
            yPos += 10;
            
            // Funil de Convers√£o
            doc.setFillColor(...secondaryColor);
            doc.rect(10, yPos, 190, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('FUNIL DE CONVERS√ÉO', 15, yPos + 6);
            yPos += 12;
            
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(9);
            
            const funnelData = [
                ['Disparos Agendados', formatNumber(totalDispatches), 'Total do m√™s'],
                ['Taxa de Entrega', (deliveryRate * 100).toFixed(0) + '%', '-'],
                ['Disparos Entregues', formatNumber(deliveredDispatches), '-'],
                ['Taxa de Resposta', (responseRate * 100).toFixed(0) + '%', '-'],
                ['Atendimentos', formatNumber(attendances), 'Meta: ' + formatNumber(minAttendance)],
                ['Taxa de CPC', (cpcRate * 100).toFixed(0) + '%', '-'],
                ['Identidade Confirmada', formatNumber(cpcConfirmed), '-'],
                ['Taxa de Convers√£o', (conversionRate * 100).toFixed(0) + '%', '-'],
                ['Acordos Gerados', formatNumber(generatedAgreements), '-'],
                ['Efetividade Pagamento', (paymentRate * 100).toFixed(0) + '%', '-'],
                ['Acordos Pagos', formatNumber(paidAgreements), 'Meta final'],
                ['Valor Recuperado', formatCurrency(targetRecovery), 'ROI = ' + effectiveROI.toFixed(1) + 'x']
            ];
            
            funnelData.forEach((row, index) => {
                if (yPos > 270) {
                    doc.addPage();
                    yPos = 20;
                }
                
                if (index === funnelData.length - 1) {
                    doc.setFillColor(...accentColor);
                    doc.rect(10, yPos - 3, 190, 7, 'F');
                    doc.setTextColor(255, 255, 255);
                }
                
                doc.setFont(undefined, 'normal');
                doc.text(row[0], 15, yPos);
                doc.setFont(undefined, 'bold');
                doc.text(row[1], 105, yPos, { align: 'center' });
                doc.setFont(undefined, 'normal');
                doc.text(row[2], 195, yPos, { align: 'right' });
                
                if (index === funnelData.length - 1) {
                    doc.setTextColor(0, 0, 0);
                }
                
                yPos += 6;
            });
            
            yPos += 5;
            
            // Configura√ß√µes Operacionais
            if (yPos > 230) {
                doc.addPage();
                yPos = 20;
            }
            
            doc.setFillColor(...secondaryColor);
            doc.rect(10, yPos, 190, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('CONFIGURA√á√ïES OPERACIONAIS', 15, yPos + 6);
            yPos += 12;
            
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(10);
            
            const configs = [
                ['Disparos por dia:', formatNumber(dailyDispatches)],
                ['Espa√ßamento entre disparos:', dispatchSpacing + ' dias'],
                ['Penetra√ß√£o de base:', basePenetration.toFixed(2) + 'x'],
                ['Dias √∫teis produtivos:', productiveDays + ' D.U.'],
                ['Capacidade total da base:', formatNumber(baseCapacity) + ' disparos'],
                ['Margem de seguran√ßa:', safetyMargin.toFixed(1) + '%']
            ];
            
            configs.forEach(config => {
                doc.setFont(undefined, 'normal');
                doc.text(config[0], 15, yPos);
                doc.setFont(undefined, 'bold');
                doc.text(config[1], 195, yPos, { align: 'right' });
                yPos += 7;
            });
            
            yPos += 5;
            
            // Alertas e Recomenda√ß√µes
            if (yPos > 240) {
                doc.addPage();
                yPos = 20;
            }
            
            doc.setFillColor(...secondaryColor);
            doc.rect(10, yPos, 190, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('PONTOS DE ATEN√á√ÉO', 15, yPos + 6);
            yPos += 12;
            
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            
            if (useMinimumScenario) {
                doc.text('‚Ä¢ C√°lculo ajustado para priorizar o m√≠nimo garantido de ' + formatNumber(minAttendance) + ' atendimentos', 15, yPos, { maxWidth: 180 });
                yPos += 6;
                doc.text('‚Ä¢ ROI efetivo (' + effectiveROI.toFixed(1) + 'x) ficou acima do objetivo (' + targetROI + 'x)', 15, yPos, { maxWidth: 180 });
                yPos += 10;
            } else {
                doc.text('‚Ä¢ Cen√°rio ideal alcan√ßado: ROI e m√≠nimo garantido atendidos simultaneamente', 15, yPos, { maxWidth: 180 });
                yPos += 10;
            }
            
            if (basePenetration > 2) {
                doc.text('‚Ä¢ Aten√ß√£o: Penetra√ß√£o de base alta (' + basePenetration.toFixed(2) + 'x). Considere aumentar base.', 15, yPos, { maxWidth: 180 });
                yPos += 10;
            }
            
            if (safetyMargin < 10) {
                doc.text('‚Ä¢ Aten√ß√£o: Margem de seguran√ßa baixa (' + safetyMargin.toFixed(1) + '%). Pouca folga operacional.', 15, yPos, { maxWidth: 180 });
                yPos += 10;
            }
            
            // Rodap√©
            doc.setFillColor(...primaryColor);
            doc.rect(0, 280, 210, 17, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(8);
            doc.text('Documento gerado pela Calculadora de Plano de A√ß√£o - Monest', 105, 290, { align: 'center' });
            
            // Salvar PDF
            const fileName = `Plano_Acao_${clientName.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);
        }
    </script>
</body>
</html>